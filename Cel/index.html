<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>คำนวณเบี้ยประกันรวม</title>
<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --muted:#9aa0b4; --text:#f5f7ff; --accent:#7c9cff; --accent2:#b07cff; --danger:#ff6b6b;
    --ring:0 0 0 2px rgba(124,156,255,.2),0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(160deg,#0b0e1a,#151935 60%,#251b3d);color:var(--text);font:16px/1.55 system-ui,Segoe UI,Inter,Arial}
  .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
  .title{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  .title h1{font-size:24px;margin:0}
  .card{background:var(--card);border-radius:16px;box-shadow:var(--ring);padding:18px;margin-bottom:18px;border:1px solid rgba(255,255,255,.06)}
  .row{display:grid;grid-template-columns:1.2fr repeat(4,1fr) 1fr 80px;gap:10px;align-items:center}
  .row.header{font-weight:600;color:var(--muted);border-bottom:1px dashed rgba(255,255,255,.08);padding-bottom:10px;margin-bottom:10px}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1326;color:var(--text);outline:none}
  input:focus,select:focus{border-color:var(--accent);box-shadow:var(--ring)}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600;color:#0b0e1a;
       background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 8px 22px rgba(124,156,255,.25)}
  .btn.secondary{background:#232744;color:var(--text);box-shadow:none;border:1px solid rgba(255,255,255,.08)}
  .btn.danger{background:var(--danger);color:#fff}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .total{display:flex;gap:18px;flex-wrap:wrap;align-items:center}
  .stat{background:#0f1326;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);min-width:240px}
  .stat b{font-size:18px}
  .muted{color:var(--muted)}
  .footnote{font-size:13px;color:var(--muted)}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  details.settings{margin-top:12px}
  details.settings summary{cursor:pointer;color:var(--muted);margin-bottom:8px}
  .tier-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 80px;gap:8px}
  .tags{display:flex;gap:8px;flex-wrap:wrap}
  .tag{font-size:12px;padding:4px 8px;border:1px dashed rgba(255,255,255,.18);border-radius:999px;color:var(--muted)}
  @media (max-width:980px){ .row{grid-template-columns:1.2fr repeat(3,1fr) 1fr 1fr 80px} }
  @media (max-width:780px){ .row{grid-template-columns:1fr 1fr;gap:8px} .row.header{display:none} .tier-grid{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <h1>คำนวณเบี้ยประกันรวม</h1>
    <span class="muted">ดึงกติกาจากไฟล์: แฟคเตอร์งวดชำระ + ส่วนลดตามช่วงทุน</span>
  </div>

  <div class="card">
    <div class="flex">
      <button class="btn" id="addRowBtn">+ เพิ่มกรมธรรม์</button>
      <button class="btn secondary" id="clearBtn">ล้างรายการ</button>
      <div class="right"></div>
      <label class="flex" style="gap:8px">
        <input type="checkbox" id="annualizeToggle" />
        <span class="muted">แสดง &ldquo;เบี้ยรวมรายปี (Factor = 1)&rdquo;</span>
      </label>
    </div>

    <div class="row header" style="margin-top:12px">
      <div>แผน/หมายเหตุ</div>
      <div>อัตราเบี้ยรายปี<br><span class="muted">ต่อหน่วย 1,000</span></div>
      <div>ส่วนลดอัตราเบี้ย<br><span class="muted">อัตโนมัติ/กำหนดเอง</span></div>
      <div>ทุนประกัน<br><span class="muted">บาท</span></div>
      <div>งวดชำระ</div>
      <div>เบี้ยต่อรอบ<br><span class="muted">คำนวณ</span></div>
      <div></div>
    </div>

    <div id="rows"></div>

    <div class="total" style="margin-top:14px">
      <div class="stat">
        <div class="muted">เบี้ยรวมต่อรอบชำระ</div>
        <b class="mono" id="grandTotal">฿0.00</b>
      </div>
      <div class="stat" id="annualStat" style="display:none">
        <div class="muted">เบี้ยรวม — รายปี (Factor = 1)</div>
        <b class="mono" id="annualTotal">฿0.00</b>
      </div>
      <div class="tags">
        <span class="tag">สูตร: ((Rate − Discount) × ทุน × Factor) ÷ 1,000</span>
        <span class="tag">แฟคเตอร์: ปี=1, 6ด.=0.52, 3ด.=0.27, เดือน=0.09</span>
        <span class="tag">ส่วนลด: อัตโนมัติตามช่วงทุน (แก้ไขได้)</span>
      </div>
    </div>

    <details class="settings">
      <summary>ตั้งค่า “ส่วนลดตามช่วงทุน” (จากไฟล์ — ปรับได้)</summary>
      <div class="muted" style="margin-bottom:8px">ระบบจะเลือก “อัตราลด” ของช่วงทุนที่ตรงที่สุด (ชนเพดานบน/ล่างรวมอยู่ในช่วง)</div>
      <div id="tierBox" class="tier-grid" style="margin-bottom:8px">
        <!-- หัวคอลัมน์ -->
        <div class="muted">ทุนต่ำสุด</div>
        <div class="muted">ทุนสูงสุด</div>
        <div class="muted">อัตราลด/พัน</div>
        <div class="muted">หมายเหตุ</div>
        <div></div>
      </div>
      <div class="flex">
        <button class="btn secondary" id="addTierBtn">+ เพิ่มช่วง</button>
        <button class="btn secondary" id="resetTierBtn">รีเซ็ตค่าเริ่มต้น</button>
      </div>
    </details>
  </div>
</div>

<template id="rowTemplate">
  <div class="row">
    <input type="text" placeholder="เช่น ตลอดชีพ 99/99 (ชาย 25)" class="plan" />
    <input type="number" step="0.01" min="0" placeholder="เช่น 12.50" class="rate" />
    <div class="flex" style="gap:6px">
      <label class="flex" style="gap:6px;align-items:center">
        <input type="checkbox" class="autoDisc" checked>
        <span class="muted" style="font-size:12px">อัตโนมัติ</span>
      </label>
      <input type="number" step="0.01" min="0" placeholder="ส่วนลด/พัน (ถ้าใส่เอง)" class="discount" disabled />
    </div>
    <input type="number" step="1000" min="0" placeholder="เช่น 300000" class="sum" />
    <select class="factor">
      <option value="1">รายปี (1.00)</option>
      <option value="0.52">ราย 6 เดือน (0.52)</option>
      <option value="0.27">ราย 3 เดือน (0.27)</option>
      <option value="0.09">รายเดือน (0.09)</option>
    </select>
    <input type="text" class="premium mono" placeholder="฿0.00" readonly />
    <button class="btn danger del">ลบ</button>
  </div>
</template>

<template id="tierTemplate">
  <div class="tier-row" style="display:contents">
    <input type="number" class="t-min" placeholder="เช่น 300000" step="1000" min="0">
    <input type="number" class="t-max" placeholder="เช่น 499999" step="1" min="0">
    <input type="number" class="t-disc" placeholder="เช่น 1.00" step="0.01" min="0">
    <input type="text" class="t-note" placeholder="เช่น ลดพิเศษช่วงทุนกลาง">
    <button class="btn danger t-del">ลบ</button>
  </div>
</template>

<script>
  // ===== Utilities =====
  const money = n => (isFinite(n) ? n : 0).toLocaleString('th-TH',{style:'currency',currency:'THB',minimumFractionDigits:2});
  const num = v => { const n = parseFloat(String(v ?? '').replace(/[, ]/g,'')); return isFinite(n) ? n : 0; };

  // ===== Discount Tiers (จากไฟล์; ปรับได้) =====
  // ค่าเริ่มต้นตามที่พบในไฟล์: ทุน ≥ 300,000 ลด 1.00 ; ทุน ≥ 500,000 ลด 1.50
  let tiers = [
    { min:300000, max:499999, disc:1.00, note:'ช่วงทุน 300k–499,999' },
    { min:500000, max:Infinity, disc:1.50, note:'ช่วงทุน ≥500k' },
  ];

  // ===== DOM =====
  const rowsEl = document.getElementById('rows');
  const rowTpl = document.getElementById('rowTemplate');
  const tierTpl = document.getElementById('tierTemplate');
  const addRowBtn = document.getElementById('addRowBtn');
  const clearBtn = document.getElementById('clearBtn');
  const grandTotalEl = document.getElementById('grandTotal');
  const annualTotalEl = document.getElementById('annualTotal');
  const annualStat = document.getElementById('annualStat');
  const annualizeToggle = document.getElementById('annualizeToggle');

  const tierBox = document.getElementById('tierBox');
  const addTierBtn = document.getElementById('addTierBtn');
  const resetTierBtn = document.getElementById('resetTierBtn');

  // ===== Tier UI =====
  function renderTiers(){
    // ล้างส่วนรายการ (คงส่วนหัว 5 ช่องแรกไว้)
    tierBox.querySelectorAll('.tier-row').forEach(el=>el.remove());
    tiers.forEach((t,i)=>{
      const node = tierTpl.content.cloneNode(true);
      const [minEl,maxEl,discEl,noteEl,delBtn] = [
        node.querySelector('.t-min'),
        node.querySelector('.t-max'),
        node.querySelector('.t-disc'),
        node.querySelector('.t-note'),
        node.querySelector('.t-del')
      ];
      minEl.value = Number.isFinite(t.min) ? t.min : '';
      maxEl.value = Number.isFinite(t.max) ? t.max : '';
      discEl.value = t.disc ?? '';
      noteEl.value = t.note ?? '';
      [minEl,maxEl,discEl,noteEl].forEach(el=>el.addEventListener('input', ()=>{
        t.min = num(minEl.value);
        const maxVal = maxEl.value === '' ? Infinity : num(maxEl.value);
        t.max = maxVal <= 0 ? Infinity : maxVal;
        t.disc = num(discEl.value);
        t.note = noteEl.value;
        recalcAll();
      }));
      delBtn.addEventListener('click', ()=>{
        tiers.splice(i,1);
        renderTiers();
        recalcAll();
      });
      tierBox.appendChild(node);
    });
  }
  renderTiers();

  addTierBtn.addEventListener('click', ()=>{
    tiers.push({min:0,max:0,disc:0,note:''});
    renderTiers();
  });

  resetTierBtn.addEventListener('click', ()=>{
    tiers = [
      { min:300000, max:499999, disc:1.00, note:'ช่วงทุน 300k–499,999' },
      { min:500000, max:Infinity, disc:1.50, note:'ช่วงทุน ≥500k' },
    ];
    renderTiers(); recalcAll();
  });

  function getAutoDiscount(sum){
    // เลือกช่วงที่ตรงกับทุน (priority: ช่วงที่ min สูงสุดที่ยัง ≤ sum)
    const candidates = tiers.filter(t => sum >= t.min && sum <= (Number.isFinite(t.max)? t.max : Infinity));
    if (candidates.length === 0) return 0;
    candidates.sort((a,b)=>b.min - a.min);
    return num(candidates[0].disc);
  }

  // ===== Rows =====
  function calcRow(row){
    const rate = num(row.querySelector('.rate').value);
    const sumV = num(row.querySelector('.sum').value);
    const factor = num(row.querySelector('.factor').value);
    const auto = row.querySelector('.autoDisc').checked;
    const discManualEl = row.querySelector('.discount');

    let discount = auto ? getAutoDiscount(sumV) : num(discManualEl.value);
    // ป้องกันส่วนลดมากกว่า rate
    const effective = Math.max(rate - discount, 0);
    const premium = (effective * sumV * factor) / 1000;
    const annual = (effective * sumV * 1) / 1000;

    row.querySelector('.premium').value = money(premium);
    return { premium, annual };
  }

  function recalcAll(){
    let total = 0, annual = 0;
    document.querySelectorAll('#rows .row').forEach(r=>{
      const {premium, annual:ann} = calcRow(r);
      total += premium; annual += ann;
    });
    grandTotalEl.textContent = money(total);
    annualTotalEl.textContent = money(annual);
  }

  function bindRow(row){
    const auto = row.querySelector('.autoDisc');
    const disc = row.querySelector('.discount');
    function syncDiscField(){
      disc.disabled = auto.checked;
      recalcAll();
    }
    auto.addEventListener('change', syncDiscField);
    row.querySelectorAll('input,select').forEach(el=>{
      el.addEventListener('input', recalcAll);
      el.addEventListener('change', recalcAll);
    });
    row.querySelector('.del').addEventListener('click', ()=>{ row.remove(); recalcAll(); });
    syncDiscField();
  }

  function addRow(prefill={}){
    const node = rowTpl.content.firstElementChild.cloneNode(true);
    node.querySelector('.plan').value = prefill.plan ?? '';
    node.querySelector('.rate').value = prefill.rate ?? '';
    node.querySelector('.discount').value = prefill.discount ?? '';
    node.querySelector('.sum').value = prefill.sum ?? '';
    node.querySelector('.factor').value = prefill.factor ?? '1';
    rowsEl.appendChild(node);
    bindRow(node);
    recalcAll();
    return node;
  }

  document.getElementById('addRowBtn').addEventListener('click', ()=> addRow());
  document.getElementById('clearBtn').addEventListener('click', ()=>{ rowsEl.innerHTML=''; recalcAll(); });
  annualizeToggle.addEventListener('change', ()=>{ annualStat.style.display = annualizeToggle.checked ? '' : 'none'; });

  // แถวตัวอย่าง (ลบ/แก้ได้)
  addRow({plan:'แผน A', rate:12.5, sum:300000, factor:'0.27'});
  addRow({plan:'แผน B', rate:9.8, sum:200000, factor:'1'});

  recalcAll();
</script>
</body>
</html>
